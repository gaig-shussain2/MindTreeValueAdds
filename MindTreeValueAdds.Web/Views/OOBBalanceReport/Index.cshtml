@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h3 class="text-center">Extract Data For OOB Incident Analysis</h3>
<h5 class="text-center">Fetches Data from CUBE,BDM,DUCK,EDW & ADW.</h5>

<hr />
<div class="container text-right label-default" style="padding-top:5px; padding-bottom:5px;">
    <a href="Manage" style="color:white;">Click here access tool's:</a>
</div>
<hr />

<div style="display:none">
    <label id="GUID">@ViewBag.GUID</label>
</div>

<div>
    <section>
        <div class="container">
            <div>
                <h5 style="color:red;"><b>Note:</b></h5>
                <h6>Use Submission Id text box to extract data submission wise. It will help us to extract data for huge policy.</h6>
                <h6>Append "<b>X</b>" at the end of the policy (e.g. CAP 000000 00 00 <b>X</b>) to get transaction level data and avoid coverage level data from EDW/ADW.</h6>
            </div>

            <br />

            <form method="post">
                <div class="form-horizontal">

                    <div class="col-md-12">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="Server">Select Server</label>
                                <label style="color:red;">*</label>
                                @Html.DropDownList("Server", null, new { @id = "Server", @class = "form-control", @name = "Server" })
                            </div>
                        </div>
                        <div class="col-md-4" id="divPolicyNumber">
                            <div class="form-group">
                                <label for="PolicyNumber">Enter Policy #</label>
                                <label style="color:red;">*</label>
                                <input type="text" class="form-control" id="PolicyNumber" placeholder="CAP AU0000 00 00" name="PolicyNumber" autocomplete="off">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="Server">Enter Submission Id</label>
                                <textarea class="form-control" id="SubmissionIDs" placeholder="123456789,98765431,7689653"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-12">
                        <input type="checkbox" id="AdvanceOption" name="AdvanceOption" />
                        <label for="AdvanceOption">Advance Option</label><br>
                    </div>

                    <div class="col-md-12">
                        <button type="button" class="btn btn-primary" id="btn_Submit">Submit</button>
                        <button type="button" class="btn btn-danger" id="btn_Clear">Clear</button>
                    </div>
                </div>
            </form>
        </div>
    </section>

    <section>
        <div class="container">
            <div style="text-align: right;">
                <a href="~/OOBBalanceReport/DownloadErrorLogs" target="_blank">Click here to download error logs.</a>
            </div>
        </div>
    </section>

    <section>
        <div class="container">
            <div style="text-align: right;">
                <h4><b>Result Section</b></h4>
            </div>
            <div style="width:100%; margin:0 auto;" id="ResultDiv"></div>
            <div class="msgclass alert" id="DownloadLink" hidden></div>
        </div>
    </section>
</div>

@* jQuery Version 3.3.1 is obsilated from this project. Adding latest jQuery file referance to fix that. *@
<script src="~/Scripts/jquery-3.6.0.min.js"></script>

<script type="text/javascript">
    $(document).ready(function () {
        function ShowTosterMessage(Type, Title, Alert) {
            var timeOut = 3000;
            var showCloseButton = true;

            if (Type == 'success') {
                toastr.success(Alert, '', { timeOut: timeOut, 'closeButton': showCloseButton });
            }
            else if (Type == 'warning') {
                toastr.warning(Alert, '', { timeOut: timeOut, 'closeButton': showCloseButton });
            }
            else if (Type == 'error') {
                toastr.error(Alert, '', { timeOut: timeOut, 'closeButton': showCloseButton });
            }
        }

        $.fn.ShowMessage = function (addClassVal, message) {
            var a = document.createElement("a");
            a.textContent = message;
            $('#DownloadLink').empty();
            $("#DownloadLink").removeClass('alert-danger');
            $("#DownloadLink").removeClass('alert-warning');
            $("#DownloadLink").removeClass('alert-success');
            $('#DownloadLink').addClass(addClassVal);
            $("#DownloadLink").append(a);
            $('#DownloadLink').show();
        };

        function ValidateScreen() {
            var isValidScreen = true;
            if ($('#PolicyNumber').val() == '') {
                isValidScreen = false;
                ShowTosterMessage('warning', 'Warning', 'Invalid Policy Number.');
            }

            return isValidScreen;
        }

        $.fn.ClearAll = function () {
            $('#PolicyNumber').val("");
            $('#PolicyNumber').prop("disabled", false);

            $('#Server').prop("disabled", false);

            $('#VersionNumber').val("1");
            $('#VersionNumber').prop("disabled", false);

            $('#DownloadLink').show = false;
            $('#DownloadLink').empty();
            $("#DownloadLink").removeClass('alert-danger');
            $("#DownloadLink").removeClass('alert-warning');
            $("#DownloadLink").removeClass('alert-success');

            $('#btn_Submit').prop('disabled', false);
        };

        $("#btn_Clear").click(function () {
            $('#element').ClearAll()
        });

        $("#btn_Submit").click(function () {
            var isValidScreen = ValidateScreen();

            var AdvanceOption = false;
            if ($('input[type="checkbox"]').is(":checked")) {
                AdvanceOption = true;
            }

            if (isValidScreen == true) {
                $('#element').ShowMessage('alert-warning', 'Processing...!')
                $.ajax({
                    type: 'GET',
                    url: '@Url.Action("ValidatePolicy")',
                    datatype: JSON,
                    data: { 'PolicyNumber': $('#PolicyNumber').val(), 'Server': $('#Server').val() },
                    success: function (data) {
                        if (data == 'success') {
                            $.ajax({
                                type: 'GET',
                                url: '@Url.Action("ExtractOOBReport")',
                                datatype: JSON,
                                data:
                                {
                                    'PolicyNumber': $('#PolicyNumber').val(),
                                    'Server': $('#Server').val(),
                                    'SubmissionIDs': $('#SubmissionIDs').val(),
                                    'AdvanceOption': AdvanceOption,
                                    'key': $('#GUID').html()
                                },
                                success: function (data) {
                                    if (data == '' || data == null) {
                                        $('#element').ShowMessage('alert-danger', 'Oops. Error in fatching data from server.');
                                    }
                                    else {
                                        if (data.includes("==")) {
                                            var result = data.split('==');
                                            window.location = 'DownloadReportNew?CallingName=' + $('#PolicyNumber').val() + '&CallingType=OOBReport' + '&filePath=' + result[1] + '&key=' + $('#GUID').html();

                                            var eg = 'DownloadReportNew?CallingName=' + $('#PolicyNumber').val() + '&CallingType=OOBReport' + '&filePath=' + result[1] + '&key=' + $('#GUID').html();
                                            var a = document.createElement("a");
                                            a.href = eg;
                                            a.textContent = "File Downloded. Click here to download again.";
                                            $('#DownloadLink').empty();
                                            $("#DownloadLink").removeClass('alert-danger');
                                            $("#DownloadLink").removeClass('alert-warning');
                                            $('#DownloadLink').addClass('alert-success');
                                            $("#DownloadLink").append(a);
                                            $('#DownloadLink').show();
                                        }
                                        else {
                                            $('#element').ShowMessage('alert-danger', 'Oops. Error in fatching data from server.');
                                        }
                                    }
                                },
                                error: function () {
                                    $('#element').ShowMessage('alert-danger', 'Oops. Error in fatching data from server.');
                                }
                            });
                        }
                        else { $('#element').ShowMessage('alert-danger', data); }
                    },
                    error: function (){
                        ShowTosterMessage('error', 'Error', 'Oops. Error in verifying policy #.');
                    }
                });
            }
        });
    });
</script>